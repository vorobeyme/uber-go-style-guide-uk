# Уникайте `init()`

Уникайте `init()` де це можливо. Якщо використання `init()` неминуче або ж бажане,
ваш код повинен:

1. Бути повністю детермінованим, незалежно від програмного середовища чи виклику.
2. Уникайте залежності від порядку або побічних ефектів інших функцій `init()`.
   Хоча порядок виклику `init()` добре відомий, код може змінюватися, і відповідно зв'язки
   між функціями `init()` можуть зробити код крихким та схильним до помилок.
3. Уникайте доступу або маніпулювання глобальним станом або станом середовища,
   таким як інформація про систему, змінні середовища, робочий каталог,
   аргументи виклику, вхідні дані програми тощо.
4. Уникайте операцій вводу-виводу (I/O), включаючи файлову систему, мережу та системні виклики.

Код, який не відповідає наведеним вище вимогам, швидше за все, буде допоміжним кодом,
який буде викликатися як частина `main()` (або в іншому місці життєвого циклу програми),
або буде написаний як частина самого `main()`.
Зокрема, бібліотеки, що призначені для використання іншими програмами, повинні бути
особливо обережними, щоб бути повністю детермінованими та не виконувати "магію ініціалізації".

<table>
<thead><tr><th>Не рекомендовано</th><th>Рекомендовано</th></tr></thead>
<tbody>
<tr><td>

```go
type Foo struct {
    // ...
}

var _defaultFoo Foo

func init() {
    _defaultFoo = Foo{
        // ...
    }
}
```

</td><td>

```go
var _defaultFoo = Foo{
    // ...
}

//  або так, краще для тестування:

var _defaultFoo = defaultFoo()

func defaultFoo() Foo {
    return Foo{
        // ...
    }
}
```

</td></tr>
<tr><td>

```go
type Config struct {
    // ...
}

var _config Config

func init() {
    // Не рекомендовано: на основі поточного каталогу
    cwd, _ := os.Getwd()

    // Не рекомендовано: I/O
    raw, _ := os.ReadFile(
        path.Join(cwd, "config", "config.yaml"),
    )

    yaml.Unmarshal(raw, &_config)
}
```

</td><td>

```go
type Config struct {
    // ...
}

func loadConfig() Config {
    cwd, err := os.Getwd()
    // обробка помилки

    raw, err := os.ReadFile(
        path.Join(cwd, "config", "config.yaml"),
    )
    // обробка помилки

    var config Config
    yaml.Unmarshal(raw, &config)

    return config
}
```

</td></tr>
</tbody></table>

Враховуючи вищезазначене, деякі ситуації, в яких `init()` може бути кращим або необхідним,
можуть включати:

- Складні вирази, які не можна представити як окреме призначення.
- Підключаються хуки, такі як діалекти `database/sql`, реєстри типів кодування тощо.
- Оптимізація для [Google Cloud Functions] та інших форм детермінованих попередніх обчислень.

  [Google Cloud Functions]: https://cloud.google.com/functions/docs/bestpractices/tips#use_global_variables_to_reuse_objects_in_future_invocations
